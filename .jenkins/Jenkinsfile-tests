#!groovy
pipeline {
    agent { label 'pcsgs02 || pcsgs03 || pcsgs04 || pcsgs05' }
    environment {
        GITLAB_TOKEN = credentials('PLSSVM-GitLab-Api')
    }
    stages {
        stage('init') {
            steps {
                dir('plssvm') {
                    sh '''
                        gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                        curl --verbose\
                            --request POST \
                            --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                            --header "Content-Type: application/json" \
                            --header "authorization: Bearer ${gitlab_token}" \
                            --data "{
                                \\"state\\": \\"running\\",
                                \\"context\\": \\"jenkins-ctest\\",
                                \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                                \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/PLSSVM/$BUILD_NUMBER/console\\"
                        }"
                    '''
                }
            }
        }
        stage('checkout') {
            steps {
                dir('plssvm') {
                    checkout scm
                }
            }
        }
        stage('setup python'){
            steps{
                sh '''
                    /usr/bin/python3.8 -m pip install --user arff
                    /usr/bin/python3.8 -m pip install --user pandas
                    /usr/bin/python3.8 -m pip install --user sklearn
                '''
            }
        }
        stage('build plssvm Release') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        cd SVM
                        mkdir -p build/Release
                        cd build/Release
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Release ../../
                        make -j4
                    '''
                }
            }
        }
        stage('run tests Release') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        cd SVM
                        git checkout 873c8e0efbe8563ab0a688d297f0720998e9304b -- platform_configuration.cfg
                        cd build/Release
                        ctest -j4
                    '''
                }
            }
        }
        stage('build plssvm Debug') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        cd SVM
                        mkdir -p build/Debug
                        cd build/Debug
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Debug ../../
                        make -j4
                    '''
                }
            }
        }
        stage('run tests Debug') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        cd SVM
                        git checkout 873c8e0efbe8563ab0a688d297f0720998e9304b -- platform_configuration.cfg
                        cd build/Debug
                        ctest -j4
                    '''
                }
            }
        }
    }
    post {
        success {
            sh '''
                gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                    --request POST \
                    --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                    --header "Content-Type: application/json" \
                    --header "authorization: Bearer ${gitlab_token}" \
                    --data "{
                        \\"state\\": \\"success\\",
                        \\"context\\": \\"jenkins-ctest\\",
                        \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/PLSSVM/$BUILD_NUMBER/console\\"
                }"
            '''
        }
        failure {
            sh '''
                gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                    --request POST \
                    --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                    --header "Content-Type: application/json" \
                    --header "authorization: Bearer ${gitlab_token}" \
                    --data "{
                        \\"state\\": \\"failed\\",
                        \\"context\\": \\"jenkins-ctest\\",
                        \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/PLSSVM/$BUILD_NUMBER/console\\"
                }"
            '''
        }
        aborted {
            sh '''
                gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                    --request POST \
                    --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                    --header "Content-Type: application/json" \
                    --header "authorization: Bearer ${gitlab_token}" \
                    --data "{
                        \\"state\\": \\"canceled\\",
                        \\"context\\": \\"jenkins-ctest\\",
                        \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/PLSSVM/$BUILD_NUMBER/console\\"
                }"
            '''
        }
    }
}